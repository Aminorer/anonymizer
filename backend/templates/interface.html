<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Interface Unifiée</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
  <link rel="stylesheet" href="/static/css/interface.css" />
</head>
<body>
  <div id="app">
    <h2>Interface Unifiée</h2>
    <div class="controls">
      <button @click="changeView('original')">Original</button>
      <button @click="changeView('anonymized')">Anonymisé</button>
      <button @click="zoomIn">Zoom +</button>
      <button @click="zoomOut">Zoom -</button>
      <button @click="prevPage">Précédent</button>
      <button @click="nextPage">Suivant</button>
      <span>{{ currentPage }} / {{ totalPages }}</span>
    </div>
    <div class="container">
      <div id="viewer" class="viewer"></div>
      <div class="side-panel">
        <div class="tabs">
          <button @click="activeTab='entities'">Entités</button>
          <button @click="activeTab='groups'">Groupes</button>
          <button @click="activeTab='search'">Recherche</button>
          <button @click="activeTab='rules'">Règles</button>
        </div>
        <div v-if="activeTab==='entities'">
          <div class="entity-actions">
            <button @click="showDetectionModal=true">Ajouter détection</button>
            <button @click="deleteSelected">Supprimer sélection</button>
          </div>
          <table class="entity-table">
            <thead>
              <tr>
                <th></th>
                <th>Type</th>
                <th>Valeur</th>
                <th>Remplacement</th>
                <th>Page</th>
                <th v-if="processingMode==='ai'">Confiance</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(ent,idx) in entityStore.items" :key="ent.id" draggable="true"
                  @dragstart="dragStart(idx,$event)" @dragover.prevent @drop="drop(idx)">
                <td><input type="checkbox" v-model="selected" :value="ent.id" /></td>
                <td><input v-model="ent.type" @change="updateEntity(ent)" /></td>
                <td><input v-model="ent.value" @change="updateEntity(ent)" /></td>
                <td><input v-model="ent.replacement" @change="updateEntity(ent)" /></td>
                <td><input v-model.number="ent.page" type="number" @change="updateEntity(ent)" /></td>
                <td v-if="processingMode==='ai'"><input v-model.number="ent.confidence" type="number" step="0.01" @change="updateEntity(ent)" /></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div v-if="activeTab==='groups'">
          <div class="group-actions">
            <button @click="showGroupModal=true">Créer groupe</button>
          </div>
          <ul class="group-list">
            <li v-for="grp in groupStore.items" :key="grp.id" @dragover.prevent @drop="assignToGroup(grp.id,$event)">
              {{ grp.name }} ({{ grp.entities.length }})
              <button @click="deleteGroup(grp.id)">x</button>
            </li>
          </ul>
        </div>
        <div v-if="activeTab==='search'">
          <select v-model="searchType">
            <option value="text">Texte</option>
            <option value="regex">Regex</option>
            <option value="semantic">Sémantique</option>
          </select>
          <input v-model="searchTerm" placeholder="Rechercher" />
          <button @click="search">Go</button>
        </div>
        <div v-if="activeTab==='rules'">
          <h3>Patterns Regex</h3>
          <div v-for="(rule,idx) in rules.regex_rules" :key="idx">
            <input v-model="rule.pattern" placeholder="Pattern" />
            <input v-model="rule.replacement" placeholder="Remplacement" />
            <button @click="removeRegex(idx)">x</button>
          </div>
          <div>
            <input v-model="newRegex.pattern" placeholder="Pattern" />
            <input v-model="newRegex.replacement" placeholder="Remplacement" />
            <button @click="addRegex">Ajouter</button>
          </div>
          <h3>Paramètres NER</h3>
          <div>
            <input v-model="rules.ner.model" placeholder="Modèle" />
            <input v-model.number="rules.ner.confidence" placeholder="Confiance" type="number" step="0.01" />
          </div>
          <h3>Styles de remplacement</h3>
          <div v-for="(style,type) in rules.styles" :key="type">
            <input v-model="rules.styles[type]" :placeholder="type" />
            <button @click="removeStyle(type)">x</button>
          </div>
          <div>
            <input v-model="newStyle.type" placeholder="Type" />
            <input v-model="newStyle.style" placeholder="Style" />
            <button @click="addStyle">Ajouter</button>
          </div>
          <button @click="saveRules">Enregistrer</button>
        </div>
      </div>
    </div>
    <div v-if="showDetectionModal" class="modal">
      <div class="modal-content">
        <h3>Ajouter détection</h3>
        <input v-model="newDetection.type" placeholder="Type" />
        <input v-model="newDetection.value" placeholder="Valeur" />
        <button @click="confirmDetection">Ajouter</button>
        <button @click="showDetectionModal=false">Annuler</button>
      </div>
    </div>
    <div v-if="showGroupModal" class="modal">
      <div class="modal-content">
        <h3>Créer groupe</h3>
        <input v-model="newGroupName" placeholder="Nom du groupe" />
        <button @click="confirmGroup">Créer</button>
        <button @click="showGroupModal=false">Annuler</button>
      </div>
    </div>
    <div id="download" v-if="status">
      <button @click="showExportModal=true">Exporter anonymisé</button> |
      <a :href="status.original_url">Télécharger original</a>
    </div>
    <div v-if="showExportModal" class="modal">
      <div class="modal-content">
        <h3>Paramètres d'export</h3>
        <label>Filigrane</label>
        <input v-model="watermark" placeholder="Texte du filigrane" />
        <label><input type="checkbox" v-model="wantAudit" /> Rapport d'audit</label>
        <button @click="exportDoc">Exporter</button>
        <button @click="showExportModal=false">Annuler</button>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/pinia@2/dist/pinia.iife.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/docx-preview@0.4.1/dist/docx-preview.js"></script>
  <script src="/static/js/app.js"></script>
</body>
</html>
